AUN to Econet Bridge
--------------------


/*
  (c) 2021 Chris Royle
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.

*/

THANKS
------

Two individuals, KL and IW (you know who you are) did extensive testing
of both the hardware and software involved in this project (aka trying
quite hard to break it!) in July and August 2021. I am very grateful to
them for their efforts. I should also like to express my thanks to
the following on the stardot.org.uk forums for their help, ideas, and
patience: @arg, @sweh, @IanJeffray, @Simon - and there are probably 
others whom I have inexcusably failed to remember - thank you all.

The fileserver code in this repository would not have been possible to
develop without sight of the code at github.com/stardot/ArduinoFilestore.
I am told it is stardot.org.uk user @gazzaD - well, @gazzaD, thank you -
I could not have done it without you.

Introduction
------------

The combination of this hardware and software is intended to provide a
bridge between a real BBC Econet and the AUN world of BeebEm (and probably
other things which use AUN). It contains also contains a relatively operable
Level3-ish fileserver, and an emulation of an Acorn print server, capable
of use by both BeebEm and real BBCs.

It is possible to put two (or more) of these bridges 'back to back' and join
two real BBC Econets together over the IP network, including the Internet,
providing the correct ports are opened. The necessary ports are the ones you
configure in the configuration file.

It is unnecessary for the two networks in a 'back to back' configuration such
as that to have discrete Econet network numbers. Properly configured, all
stations can be on the same network number, including 0.

What is more, if you are connecting to your friends' Econets and some of them
use the same network number as you, you can configure their networks to 
have a different number in your config and it should all work, thus the
overlapping network numbers no longer matter.

At the moment, each individual host on each individual network must be 
individually configured. A wildcard entry can be inserted to match 'all
other undefined stations on a network' but it MUST come after all defined
stations. See below.

What is is NOT
--------------

Whilst called a 'Bridge', do *not* mistake this for a direct substitute for
an Acorn(R) Econet bridge, which will join two real BBC networks together
with different network numbers. You *can* do that with this software and
its associated hardware, but you need TWO sets to do it, and the 'bridge'
is performed over AUN over IP in between the two bridges.

Caveat: The bridge query handling code in this software is a work in progress.
It doesn't do very much, and (for example) it does not broadcast known
'bridgeable' networks to other bridges yet. This is because I cannot test it
with a real Acorn bridge because I do not have one! However, that does *not*
appear to stop stations communicating with distant network numbers.

Prerequisites
-------------

** Do NOT attempt to run this on PiOS 64 bit yet. There is an incompatibility
   with the kernel module which will crash your system. I suspect it is the
   direct writes to the GPIO hardware. This is on the list to fix.
**

The system will require:
	- Raspberry Pi 4B (anything less and timing issues mean it won't work
          at the moment, but I am working on it!) With a version 2 board
	  a Pi3B may work acceptably
	- A proper RPi 4 PSU. Experimentation shows that the Econet hardware
          has quite a current draw and an underpowered PSU can lead to
          rx/tx problems
	- No other GPIO usage on the system
	- With v1 hardware (as described in here), do NOT install the Pi
	  desktop - or if you do, don't run it. 
	- Disable Wifi sleep on your Pi, especially if that is your network
	  connectivity of choice.
	- The hardware (see Hardware.pdf), which in turn requires a Master 128
          Econet board. If you buy a version 2 ready made board from 
	  @KenLowe, this *includes* the necessary econet board and a separate
	  Master 128 expansion board (i.e. an ADF10) is NOT required.
	- Your installation of PiOS having the kernel headers installed (see
          below)
	- A pre-existing functioning Econet (with clock) with a spare station
          port to connect to the hardware

You will need to fix the clock on your Pi - i.e. it MUST NOT switch in and
out of turbo mode. If you don't, then expect unreliability.

In your /boot/config.txt file, set
arm_freq=900
force_turbo=1

... and reboot. 900MHz is conservative. It'll probably work at a faster
speed quite happily.

WARNING - NO, REALLY, YOU SHOULD READ THIS!
-------------------------------------------

I was once told that the difference between a professional musician and an the
amateur is that the amateur practices until he gets the piece right; the
professional practices until the piece simply will not go wrong.

On any view, by analogy, this is amateur code.

This is work which I have produced with no real experience of either
electronics, the 68B54 ADLC, or kernel module programming.

In particular, the following undesirable characteristics of this system should
be noted. These are typically owing to a lack of talent on my part. I well
understand the desirability of fixing them all. If anyone with more talent
than me wishes to have a go, I would be genuinely very happy. Notwithstanding
the list below, I am a huge fan of doing things the 'proper' way. It is a
matter of regret that I have not managed to do so. In particular:

	- It reads and writes directly from the GPIO hardware instead of using
	  the kernel routines. I accept this renders it less portable even
	  within Raspberry Pi systems, though at least the Peripheral Base
	  address is in a #define!

	- It probably does not handle AUN ACK and NAK quite the way it should.

It is some time since I saw a kernel crash with this module, but you should be
alive to the prospect that it might happen. If you use this on a production
system that's doing something else, you have been warned!

INSTALLATION
------------

NB: Unless you have a v2 board AND you are one of the v2 board testers,
please DO NOT attempt to use the material in the v2eeprom or dts directories,
nor should you do anything that is in the 'EEPROM' file.

1. Install your kernel headers. On PiOS that requires the following (prepended
   by 'sudo ' if you are not root) (You will not need the 2nd line if you
   already have 'git' installed):

	sudo apt install raspberrypi-kernel-headers libexplain51 libexplain-dev libexplain-doc
	sudo apt install git
	sudo apt upgrade
	sudo shutdown -r now

2. Get the distribution of the bridge code. It comes in three main sections:
   kernel module, utilities, configuration

NB: All of the following steps can be automated on a new install by doing
'make install' in the top level directory of the distribution. If you are using
v2 hardware (see below), then the install routine will make the Pi autosense
the v2 HAT, load the kernel module, and start the bridge at boot. You may wish
nonetheless to edit the config file (especially if you have a wired station
at 254!). If you wish to use the High Performance Bridge (currently 
experimental - see separate README) then please use 'make install-hp'.
	
	git clone https://github.com/cr12925/PiEconetBridge

3. Build the kernel module

	cd ~/PiEconetBridge/module
	make

4. Build the utilities

	cd ~/PiEconetBridge/utilities
	make

5. Edit the configuration file (sample in config/econet.cfg) and put it in
   /etc/econet-gpio/econet.cfg

   Note: If you want to put it elsewhere that's fine - just use the '-c' option
   when running econet-bridge (see below).

   (Neither the kernel module nor the other utilities use the configuration
   file.)

LOADING THE KERNEL MODULE
-------------------------

	cd module
	sudo insmod ./econet-gpio.ko

If you are not running the utilities are root, you should change the
permissions on the newly arrived /dev/econet-gpio, e.g.:

	sudo chmod a+rw /dev/econet-gpio

If you want to choose the group / permissions for the /dev/econet-gpio device,
you can put a file such as that in the 'udev' directory into /etc/udev/rules.d

Obviously if you want to use the group 'econet' as set out in the example file,
then you will need to create it as root with something like

	groupadd econet

And then add the pi user to it with something like

	usermod -a -G econet pi

You should then find that the pi user can run the utilities (rather than root)
but can still talk to the Econet device.

A WORD ON THE KERNEL MODULE
---------------------------

The kernel module does two things:

	- First, it transmits and receives packets through the ADLC.
	- Second, it implements a state machine which does the 4-way handshake
	  and converts data packets off the wire into AUN-style packets.
	  (Internally, and when communicating with the utilities, it adds an
	  extra four bytes on the start of each packet which match those on an
	  Econet frame to make it easier to work out where a packet is going,
	  viz.  destination station, destination network, source station,
	  source network (in that order).
	
	  Similarly, any packet delivered to the kernel module when it is in
	  AUN mode must have those four extra bytes on it.

The AUN (4-way-handshake) mode is enabled when a 'station set' is delivered to
the kernel module. The station set map tells the module which stations it
should handshake for, or otherwise capture traffic for (e.g. immediates, 
broadcasts). Only stations which appear in the map (and there are macros to put
stations in the map) will have their traffic forwarded to userspace when in AUN
mode.

If no station map is put into the kernel module after a reload or reset, the
module will remain in non-AUN mode. In that mode, it captures all packets off
the wire, and does *no* 4-way handshake. It simply delivers raw packets through
/dev/econet-gpio to userspace. This mode is not useful practically, but
provides a means of doing network monitoring. Thus the 'econet-monitor'
utilities does not upload a station map, so that the module remains in 'raw'
mode.

Immediate queries are now handled properly (and forwarded on to AUN etc. if
appropriate). If you want the kernel module to spoof Immediate replies like
it used to, you must now turn on the -i command line switch to the Econet
bridge. There should be no need to do so and use is discouraged.

TESTING - HARDWARE (REALLY ONLY NEEDED IF YOU SELF-BUILD THE HARDWARE)
------------------

By all means build the hardware described here. However, better performing
hardware is available pre-built in the form of a 'version 2' board from
@KenLowe on the stardot.org.uk fora.

If, like me, you've built the hardware on a breadbaord, you should probably
test it before trying to use it. 

There is a utility 'econet-test' which puts the hardware through a test
routine whose results will require an oscilloscope to see. Essentially it
toggles the various address, control and data lines onto the 68B54 ADLC.

To use it, you must first load the kernel module since the kernel module does
the heavy lifting in this regard. See above.

To run the tests proceed as follows. It is *not* recommended you do this
with the Econet actually connected to the module until the very last step:

	cd utilities
	./econet-test

You will see a series of prompts which tell you which lines have been set and
in what way so that they can be checked with the scope. Press return or some
other key after each one to move to the next.

The last stage is that the test harness will repeatedly use a kernel ioctl()
to send a test packet onto the Econet. You will therefore need to put your
scope on the Data+ and Ground pins on the Econet connector itself to see if the 
packet is transmitted.

Note you will need a clock - the chip will not transmit otherwise.

The test packet is a 'machine peek' immediate query from 0.254 to 0.1. If
station 0.1 is alive on your particular network, it should reply and you should
see two packets in quick succession on the scope. If not, you should just see
one (the test packet itself). 

This last test phase repeats until you press Q and then Enter (case sensitive)
so that you can test repeated transmissions.

If there is a problem, watching the kernel ring buffer (dmesg -we) may give you
a clue why.

LOADING THE KERNEL MODULE
-------------------------

None of the utilities described below will do anything at all unless you
have loaded the kernel module first.

If you have one of @KenLowe's version 2 revision 2 (not revision 1)
hardware boards, it will have a programmed EEPROM on it. If you use the
'make install' routine then your driver should autoload if the Econet
board is plugged into your Pi. @KenLowe can be found on the forums at
stardot.org.uk .

Otherwise:

- If you have used the 'make install' routine, you should be able simply
  to use 

  modprobe econet-gpio

- Otherwise, move to the 'module' directory in the repo and run

  make reload

ON BOARD CLOCK / TERMINATION
----------------------------

On v2 revision 2a boards and above, the HAT has optional termination and
clock circuitry on the board. The kernel module will detect a version 2
board (including those earlier than 2a) and will:

- Put an 8MHz clock out on GPIO 4 (BCM numbering), which can be used to
  clock the ADLC. There is a hardware solder bridge which switches from
  an on-board oscillator to the Pi-supplied clock. (The 8MHz waveform
  is divided down before it gets to the ADLC, which needs 2MHz.)

- Turn on the PWM on GPIO 18 (BCM numbering) which feeds the clock
  generation circuitry on a v2r2a (and above) HAT. It will turn the
  clock on at a relatively slow speed (5us period, 1us mark).
  
  You can alter the period and mark with the econet-clock utility.
  (See below.)

If you have a board which is *earlier* than v2 r2a then do not expect 
clock generation on board - the electronics simply are not there.

(On a v1 board, the pin which is used for the PWM clock output is
used for something else, so the kernel module will not put a clock out
on it at all.)

THE UTILITIES
-------------

These run from simple to more complex. Each responds to -h on the command line
to give you help.

econet-monitor
--------------

First, econet-monitor. This reads /dec/econet-gpio with the kernel module in
raw mode and simply dumps every packet it sees.

You should see streams of packets (on an active network) which will include all
four packets (separately) of the four-way handshakes. This utilities does *not*
glue them together into one line like Acorn's own NETMON. You literally see
what's on the wire.

The output is verbose by default. You can get a one-line-per-packet (ish)
output by specifying '-b' (brief) on the command line.

One easy way to see some traffic is to run the monitor on a live econet and
press BREAK on a real BBC with the network software loaded. Certainly on a 
Master (which is all I have), the ANFS will send 9 bridge queries out. These
are short broadcasts whose packet data includes the word 'BRIDGE' and you
should see them appear on the monitor screen.

econet-imm
----------

This utility performs various sorts of 'immediate' queries on the econet. It
leaves the kernel in raw mode, sends the query and reads the next packet off
the wire and (save for the continue and halt operations) tells you what was in
it.  

It implements the following operations: Halt, Continue, Machine Peek, Memory
Peek.

In every case you *must* provide a source and destination station number. They
will both be treated as being on net 0 for the purposes of this utility, so
only local stations can be queried (i.e. not those over traditional Econet
bridges). Obviously your own source station number should not already be in
use on the network.

Examples (but see help for detail) with example output:

Send machine peek to station 1 from station 250

$ ./econet-imm -s 1 -d 250 -m
Station reports being a BBC Master 128 OS 3, NFS version 4.25.
$

Send HALT to station 1 from station 250

$ ./econet-imm -s 1 -d 250 -j
$

Send CONTINUE to station 1 from station 250

$ ./econet-imm -s  1 -d 250 -c
$

Send memory peak to station 1 from station 250 for addresses &2000 to &21FF

$ ./econet-imm -s 1 -d 250 -p -q 2000 -r 21FF
Remote memory peek received:
00002000 78 56 34 12 d0 04 a9 d4 d0 18 18 20 c3 20 20 3a 21 20 48 21 d0 0c 20 0f 22 d0 07 20 7a 22 d0 02 xV4........ .  :! H!.. .".. z"..
00002020 a9 00 48 a0 04 ad 6b 8c 91 b0 c8 ad 6c 8c 91 b0 c8 ad 72 8c 91 b0 68 4c 60 18 20 7d 1a a0 06 b1 ..H...k.....l.....r...hL`. }....
00002040 b0 20 4c 11 d0 0f 20 8d 1d d0 0a a0 09 b1 46 29 02 d0 04 a9 c1 d0 69 38 20 c3 20 ad 72 8c f0 3c . L... .......F)......i8 . .r..<
00002060 18 a0 00 b1 7c a0 09 71 b0 8d 6f 8c c8 b1 b0 a0 01 71 7c 8d 70 8c c8 b1 7c 69 00 8d 71 8c 18 a9 ....|..q..o......q|.p...|i..q...
00002080 ff 6d 6f 8c a9 04 6d 70 8c 8d 70 8c a9 00 8d 6f 8c 6d 71 8c 8d 71 8c 20 25 1d d0 24 a0 09 b1 b0 .mo...mp..p....o.mq..q. %..$....
000020a0 8d 6d 8c c8 b1 b0 8d 6e 8c 20 3a 21 20 7f 21 d0 0f 20 13 22 d0 0a 20 a8 22 d0 05 20 b0 23 a9 00 .m.....n. :! .!.. .".. .".. .#..
000020c0 4c 60 18 a9 00 8d 72 8c a0 09 b0 03 a0 06 38 b1 7c c8 8c 66 8c a0 00 f1 7c 8d 6d 8c ac 66 8c b1 L`....r.......8.|..f....|.m..f..
000020e0 7c a0 01 f1 7c 8d 6e 8c ee 66 8c ac 66 8c b1 7c a0 02 f1 7c b0 08 a9 00 8d 6d 8c 8d 6e 8c d0 18 |...|.n..f..f..|...|.....m..n...
00002100 38 ad 6d 8c a0 09 f1 b0 8d 66 8c ad 6e 8c c8 f1 b0 0d 66 8c f0 12 90 10 a0 09 b1 b0 8d 6d 8c c8 8.m......f..n.....f..........m..
00002120 b1 b0 8d 6e 8c 4c 2d 21 a9 80 8d 72 8c ad 6d 8c 8d 6b 8c ad 6e 8c 8d 6c 8c 60 a0 07 b1 b0 8d 69 ...n.L-!...r..m..k..n..l.`.....i
00002140 8c c8 b1 b0 8d 6a 8c 60 20 b9 21 c9 00 d0 03 a9 00 60 8d 66 8c 20 77 1e d0 f7 ad 69 8c 85 24 ad .....j.` .!......`.f. w....i..$.
00002160 6a 8c 85 25 a0 00 b1 7c 18 65 28 85 22 a5 29 69 00 85 23 ae 66 8c 20 59 07 20 d2 21 4c 4f 21 20 j..%...|.e(.".)i..#.f. Y. .!LO!
00002180 b9 21 c9 00 d0 03 a9 00 60 8d 66 8c 20 77 1e d0 f7 ad 69 8c 85 22 ad 6a 8c 85 23 a0 00 b1 7c 18 .!......`.f. w....i..".j..#...|.
000021a0 65 28 85 24 a5 29 69 00 85 25 ae 66 8c 20 59 07 20 67 07 20 d2 21 4c 86 21 a9 00 38 a0 00 f1 7c e(.$.)i..%.f. Y. g. .!L.!..8...|
000021c0 4c c3 21 ae 6e 8c f0 01 60 cd 6d 8c 90 fa ad 6d 8c 60 38 ad 6d 8c ed 66 8c 8d 6d 8c ad 6e 8c e9 L.!.n...`.m....m.`8.m..f..m..n..
000021e0 00 8d 6e 8c 18 ad 69 8c 6d 66 8c 8d 69 8c ad 6a 8c 69 00 8d 6a 8c 18 a0 00 b1 7c 6d 66 8c 91    ..n...i.mf..i..j.i..j.....|mf..
$

Note the first four bytes at &2000, which were put there on the real BBC with
station number 1 with the following BASIC comment:

!&2000=&12345678

econet-ledtest
--------------

Test harness utility for the activity LEDs introduced on v2 r2a boards.

When run, the system will run through a cycle of LED patterns in order
to determine whether the LED components are functional.

econet-clock
------------

If you have a v2 r2a (or above) HAT, then this utility can be used to 
set the period and mark of the Econet clock generated by the Pi and
the line drivers on the HAT. It will achieve precisely nothing if you
have a board which is lower than that revision.

Examples:

econet-clock -p 5.5 -m 1

... sets a 5.5us period with a 1us mark, apparently suitable if
you have BBCs with second processors enableed on your Econet.

For faster clocks (which may not play nicely with BBCs at all,
but may well do with Archimedes), try (for example)

econet-clock -p 3 -m 1

econet-bridge
-------------

*** This describes the first version of the bridge code. It appears
    stable and reliable. If you are looking for information on how
    to use the High Performance Bridge (the more recent, less stable,
    version) then please see README.HPBRIDGE.o

    The operation of the file & print servers in the HP Bridge is the
    same as for this version (but they are configured differently
    in the HP Bridge). So, for example, all the fileserver commands
    documented below, and the way of configuring the print handler
    script are the same between the two versions.
***

This is the main bridge code, though it is relatively simple. It uses a
configuration file which tells it about three key types of station: Wire (on
the hardware Econet), Distant (AUN stations accessible over IP) and Local
(emulated within the bridge code itself).

First, the config file. The documentation is contained in comments in the
sample. Please read it.

The bridge code looks for the config file in /etc/econet-gpio/econet.cfg by
default, but the -c switch allows you to specify an alternative.

Notes on each type of configuration line:

N n
LOCALNET n
----------

(Long form: use 'LOCALNET' instead of 'N' for readability.)

This sets the network number of the local wire Econet which the bridge will
(when the Bridge Query code is finished) be announced to other bridges. If you
don't have this, the bridge won't deal with bridge queries. This will not stop
it bridging network 0 (your local Econet) to AUN stations in network 0.

W n s p
WIRE n s p
----------

(Long form: use 'WIRE' instead of 'W' for readability.)

This creates an AUN listener on port p (on each IP address available on your
bridge machine) for host n.s on your local hardware Econet wire. (Note, because
you may have an Acorn bridge to another wired Econet, you can specify a network
other than 0.)

You must:

- Have one such entry for every station on your local Econet which needs to
  speak to the AUN world.
- Use different port numbers for each such entry. E.g. 32768, 32769, etc.
- If you use the word AUTO for the port number then it will automatically
  be calculated as 10000+network*256+port.  So, for example
    W 0 100 AUTO would result in port 10100 (10000+0*256+100)
    W 5 200 AUTO would result in port 11480 (10000+5*256+200)

  (Thanks to @sweh on stardot.org.uk for the above patch & suggestion.)

- If the station ID is a * (e.g. W 0 * AUTO) then the bridge will
  automatically define all unused stations as being wired, as if you had
  entered
    W 0 1 AUTO
    W 0 2 AUTO
    ...
    W 0 254 AUTO
  This entry should be last in the configuration file (definitely after any
  Server or Printer lines).
  e.g.
    F 0 254 AUTO /econet
    P 0 235 AUTO lp
    A 0 100 10.0.0.100 32768
    W 0 * AUTO
  would skip stations 100, 235, 254 because these are already defined, and
  define all the rest as wired.

Please see the section on "Advanced network configuration" in the NETWORK
file for another way of configuring port numbers, and which helps with
RiscOS AUN clients.

A word on port numbers
----------------------

Each Econet *wire* host or locally emulated station must have a *different*
port number because all of those stations are listened for on all IP addresses
on the local machine.

*Distant* machines - AUN hosts - e.g. BeebEm, or another bridge - can use
port numbers which appear to overlap with wire or local stations. That works
because in fact they do not overlap: the port is being listened for on the
*distant* machine, not the local bridge. 

E.g. the following configuration is perfectly good:

W 0 1 32768
W 0 2 32769
A 0 3 distant.example.com 32768
A 0 4 another.example.com 32768

... Whilst the port numbers on the 'A' lines are the same as for station 0.1,
they work because those 'A' systems are distant - they're on another machine
on the IP network. So the fact that they listen on 32768 just like we do for
station 0.1 is no problem.

A n s host p
IP n s host p
-------------

(Long form: use 'IP' instead of 'A' for readability.)

This tells the bridge that AUN host n.s is available on host 'host' (can be DNS
name or IP address) port p.

Please see the section on "Advanced network configuration" in the NETWORK
file for another way of configuring port numbers, and which helps with
RiscOS AUN clients.

The bridge will ONLY bridge to hosts you have told it about in this way.

L n
DYNAMIC n
LEARN n
---------

(Long form: use 'DYNAMIC' or 'LEARN' instead of 'L' for readability.)

The bridge will dynamically assign a station number between 1 & 254 in network
'n' (which needs to be not in use elsewhere!) to AUN traffic received from
stations and/or on ports which are not defined with 'A' (above). 

The point is that this allows AUN machines not to *have* to be configured in
the bridge providing those AUN machines know where the bridge *is* and what
ports the wire/local stations are on.

Its purpose is to allow users (including local ones) to access the wired
Econet without them having to be configured on the bridge. For example, if
you have a fileserver (in the bridge or on the wired network) and you want
your friends to be able to access it, then providing they can reach the bridge
it is unnecessary to configure their IP addresses and port numbers in the
configuration file, in case, for example, they change because their ISP
provides a dynamic IP address.

Note that *no* filtering is done here - by definition, the bridge will let
allcomers in!

The bridge will time out a dynamic address if it sees no traffic for 1 hour.
This is not a configurable timeout, but it *is* in a #define in 
econet-bridge.c and you should feel free to change it if you want.

When the bridge allocates an apparently unused (including a timed out) 
station number to a new user, it will

 - tell all locally emulated fileservers to log the station off (in case
   they were logged on)
 - spoof an 'end session' command to any wired fileservers it has 
   detected traffic for (which it does by detecting traffic to port &99).

That is to prevent a newcomer accidentally inheriting access to a
fileserver from a previous dynamic user.

P n s p printer
---------------

The bridge will accept print jobs with a locally emulated print server on host
n.s port p. It will spool the output provided by the host (which can be another
AUN host as well as a real BBC on the Econet wire) into a temporary file, and
when completed it will despatch it using 'lp' to the printer named 'printer'.
By editing the header file include/econet-pserv.h you can alter the command
line format which is used and, if you wish, use an entirely different printing
command. Unfortunately, at present, there is one command per bridge - so all
virutalized print servers use the same command. I suppose it would be possible
to alter the configuration format simply to specify the command to be used on a
per-server basis.

UNIX n s p path
---------------

Creates a two named pipes (path.tobridge and path.frombridge) over which the
bridge will send and receive AUN format packets. O_SYNC must be used to ensure
whole packets go into the pipe and come out as single units.

This enables a user to create a userspace program which interacts with Econet
and AUN hosts (including over a trunk or bridge) simply by listening for 
AUN format traffic (with the bridge extensions for source/destination net and
station - so 12 bytes before the data) and responding by writing traffic
down the other (appropriately named) pipe.

The station number will be n.s and external AUN-type traffic can reach the
station in the usual way on port p, or from the Econet wire, or over a trunk.

The sending userspace code which connects up to the pipe to talk to the bridge
*does not* need to put a source address in the packets it generates. The
bridge will overwrite any source address so included with n.s on arrival 
before transmission.

Potential uses include file or print servers, or other types of services which
might usefully run on the bridge machine but which are not part of the bridge
already.

Some example code is provided:

econet-pipe.c compiles to econet-pipe.o and is a static liability of handy
functions for opening the pipes and getting traffic to/from the bridge from
your new userspace application.

As with all these examples, the -p command line switch indicates the base
path of the named pipes and should match the 'path' parameter in 
the config line above.

pipe-eg is an example program which does a bridge query to find out its
local network number (if there is a bridge handy), displays it, and will then
respond to machine type queries (immediate $88), and will also (fake)
responses to fileserver version enquiries, so that running this will 
cause a response to the SJ Research *FSLIST utility. (Anything else send to
it as a fileserver will fail.)

econet-notify emulates *NOTIFY on a BBC. It, too, will do a bridge query
just for good measure, and will then do a machine peek to see whether the
destination machine is on the network somewhere (it can be AUN, trunked, or
on the wire). If it is, it will send a series of Immediate $85 packets,
each containing a character of the message (wrapped with a beep character
and some underscores).

econet-ipgw is an experimental gateway which will ultimately carry IP over
Econet traffic from Philip Blundell's TCP/IP ROM. Further documentation in the
TCPIP file.

ecoent-remote is a Unix version of *REMOTE, for taking control of a remote
real BBC (BeebEm does not presently support the traffic format), providing
the BBC is not in protected mode.

Running the bridge
------------------

As long as the device has been made world writeable or is accessible by your
current user (e.g. by using the udev configuration and putting the device into
a group of which you are a member) (see above) you should be able to run the
bridge from a non-privileged user as follows:

$ ./econet-bridge

It will produce little output in this mode, save for errors.

The -h command line switch will give you help as to other things you can do. 

-a <ms>   : Change the AUN interpacket gap - milliseconds. This is the period
	    the bridge will wait before retransmitting a packet to an
	    AUN station.
-b        : When specified with -d, produces abbreviated (~ 1 line per packet)
	    output.
-c <path> : Use alternative config.
-d        : Produce packets on stderr as they come and go. These will be
	    AUN-type (i.e. not raw off the wire), post 4-way h/shake.
-e <ms>	  : Alter the long stop wait time for an econet packet to transmit
	    on the wire. Longer will slow down the bridge, potentially,
	    but may increase reliability.
-f	  : Stop the fileserver from producing log output to stderr.
	    (Incompatible with -n and if specified after -n will take
	    precedence.)
-g <ms>	  : Change the Econet wire interpacket gap - milliseonds. This is
	    the period the bridge will wait before trying to send an
	    econet packet (to any station on the wire) where previous
	    transmission(s) have failed. Default is 10ms. Faster means
	    potentially better performance.
-i	  : Turns on old immediate mode spoofing. Should not be required.
-k	  : Turns on slightly more kernel logging (e.g. about collisions)
-l	  : Stops the bridge code talking to the Econet hardware. Useful
	    for testing, or if you just want to run a fileserver without any
	    connection to a wired Econet.
-n	  : Makes the fileserver log output noisy. Will tell you much more
	    about what it is doing, notably on file reads/writes/bulk
	    transfer. (Incompatible with -f and if specified after -f will
	    override it.)
-m	  : Turns on FS 'normalize' debugging (e.g. translation of Acorn
	    to Unix filesystem naming). Produces a lot of output. Not
	    normally needed.
-q        : Don't do bridge query responses
-r	  : Turns on traffic queue debugging. Should not normally be
	    needed. Avoid.
-s        : Dump a summary of the config file before bridging - useful for
	    checking the config has been read.
-x	  : Force use of .inf files instead of xattr in Fileserver.
	    Affects all locally emulated fileservers.
-w <ms>	  : Change the wait time for immediate relies (milliseconds).
	    Shorter = more responsive; Longer = more reliable. Default is
	    500ms. After this timeout, the bridge will likely re-set the
	    kernel module back to read mode where it is waiting for an
	    immediate reply from AUN.
-z	  : Stop the bridge from sending an automatic *BYE to known
	    fileservers where a dynamically allocated AUN station joins
	    the network. This should normally not be used, because it is
	    important that a new dynamic station does not inherit the login
	    to fileservers which any previous holder of the same net/stn
	    combination had.
-7	  : By default, the FS will use the '7 bit bodge' for dates to
 	    provide some Y2K compliance. This turns the option off and
  	    reverts to 'original' Acorn year numbering which tops out at 
	    about 1997.


EXAMPLE CONFIG & USAGE
----------------------

Suppose you have live stations 1 & 2 on the Econet, and a fileserver on an AUN
machine with IP 5.6.7.8 on port 32768.

Let us imagine the server is running BeebEm. Let us imagine that the Raspberry
Pi running the bridge has IP address 1.2.3.4.

Note that BeebEm MUST be in AUN mode and have SINGLESOCKET set to 1 (these are
default settings as I understand it).

The bridge configuration would be:
WIRE 0 1 32768
WIRE 0 2 32769
IP 0 254 5.6.7.8 32768

The tail end of the BeebEm econet.cfg file would read thus:

0 1 1.2.3.4 32768           <--- Matches the port number on 'W 0 1 ...' above
0 2 1.2.3.4 32769           <--- Ditto W 0 2
0 254 5.6.7.8 32768

Make sure your BeebEm configuration includes an NFS ROM of some kind and Econet
is enabled in the options. Make sure BeebEm wakes up and doesn't complain about
not being able to find an Econet address.

Start up, e.g., a Level 3 fileserver in BeebEm.

Next, load the kernel module on the Raspberry Pi (see above).

Then run the bridge as above.

You should find your real BBC can log into the BeebEm Fileserver.

The reverse also works - logging into a real BBC fileserver (or potentially SJ
Research, but I don't have one) from BeebEm.


DEFAULT CONFIGURATION
---------------------

The system ships with a default configuration file (installed for you with
the top level 'make install' if there isn't a config file present already) which
will recognize all wired stations, will number the local network as 1, and
implement a local fileserver at station number 254 (with files stored in 
/home/pi/econetfs). The fileserver is accessible over AUN at port 32768 on the
Pi's local IP address.

TRUNKING, FIREWALLING AND NETWORK ADDRESS TRANSLATION
-----------------------------------------------------

Examples of all of the following are in the sample config file.

Trunking: This allows you to configure a single host & port combination
which will receive all traffic for all hosts on particular networks. 

This saves having to specify all the hosts on a remote network and saves
each one having its own UDP port open at the other end.

Trunks learn which networks are where by sending and receiving bridge
reset (&80) and update (&81) packets. Every 5 minutes, the bridge will
do a full reset in case anything went wrong. In doing the adverts, it will
apply the address translation mapping for your local networks. It will
*never* advertise net 0, so to enable the functionality you *must* 
specify a local network number with 'N'.

NOTE: Traffic from other AUN stations WILL NOT be put on the trunk. That is
because those local AUN stations will not know where to send the traffic
for the distant networks.

The bridge *can* forward from one trunk to another. When it does so, it
disables its intelligent waiting routine which looks for replies to 
immediates and data packets, and leaves the distant ends to do it.

Each trunk has a manually configured number, starting at 1.

NOTE: Trunking CANNOT at present be used to bridge two net 0's together.
It may be that some clever learning process can be implemented at a later 
date, but for now it is not there. Don't try it, you will likely become
frustrated.

Address translation: It is considered helpful that, if two sites use
overlapping network numbers, they need not renumber in order to communicate
over a bridged trunk. Address translation (the 'X' configuration entry)
allows you to specify, on a per trunk basis, the local network number
and a different network number by which the local net is seen at the
far end of the trunk. E.g. 'X 1 2 3' will translate local network 2
to be seen as network 3 at the other end of trunk 1. The translation
is undone when traffic is received.

NOTE: Do not attempt to translate net 0. Always use you local network
number ('L' configuration entry) instead.

Firewalling: Sometimes it is useful to be able to stop remote stations
on a given trunk talking to particular hosts - e.g. development
machines, or private filestores. The 'Y' parameter allows you to
configure a per-trunk firewall system based on source network/host and
destination network/host. The default policy is ACCEPT. The rules are
executed in order each time a packet arrives.

NOTE: Firewalling is only done INBOUND. There is no outbound filtering;
you can send what you like. If the other end filters it, so be it.

NOTE: Network or host 255 is used as the wildcard to mean "anything".
It does NOT mean broadcast.

Broadly speaking:

TRUNK n port host port - defines trunk 'n' on local port 'port'
      connected to distant host 'host' on port 'port' (the 2nd one)
      These are UDP ports.

XLATE n x y - on trunk 'n', translate inbound advertisement of network x
      to network y - so your local machines will use y.XXX not x.XXX to
      talk to machines on this network over the trunk.

FIREWALL n snet sstn dnet dstn DROP|ACCEPT
      Filter inbound traffic on trunk 'n' so that sources matching
      snet.sstn will either have their traffic dropped or accepted
      (depending on the final parameter) when sending traffic to 
      hosts matching dnet.dstn. 

      Each of snet, sstn, dnet, dstn can be 255, which is a wildcard
      for 'all nets' / 'all stations'.

FILTER IN|OUT n net 
      Filters adverts for net 'net' on trunk 'n' either inbound
      or outbound - less granular than 'FIREWALL' for security
      purposes - this prevents reception of the inbound advert
      altogether or, for 'OUT', prevents the bridge from advertising
      the network outbound at all.

      Can be useful if you think there's a bridge loop somewhere,
      although the bridge will make efforts not to accept an inbound
      advert on a trunk or the wire if it thinks the same network
      is reachable by the same route.

econet-fslist
-------------

Uses the PIPE client connector (see configuration instructions) to
do the equivalent of the MDFS *FSLIST utility. It broadcasts a file
server version query and displays the answers. Without a pipe connector
configured, this will not do anything for you.

-p specifies the named pipe pair that the utility will use to talk to the
network.

TO DO
-----

- Implement device tree so that the GPIO pins are defined outside the code
- Use better routines to access GPIOs in kernel

KNOWN BUGS
----------

- Incompatible with PiOS 64 bit

PRINT & FILE SERVERS
--------------------

See below. It is possible to:

a) 	Run more than one file or print server within the same bridge.
b) 	Run the File and Print servers on the same emulated station. 

In case (b), the port number used will be ignored when the second station
definition is used.

An optional Acorn printer name (6 characters max) can be specified
by adding ':NAME' to the printer definition where NAME is the Acorn
printer name. The system supports multiple printers per server, and
will respond to printer status queries from the SJ MDFS *PS utility.

Example:

F 0 254 32768 /econet
P 0 254 37000 matrix
P 0 254 37000 epson:FX80

Will create one fileserver rooted at /econet, and a print server, both on
station 0.254. However, the listener will be on 32768 - because by the time 
the print server config is read, station 0.254 already exists and has a 
listener on 32768, so the 37000 port number is *ignored*. The first 'P'
line will create a printer which sends traffic to the lp subsystem printer
called 'matrix' and, because there is no ':NAME' element, it will also
give the printer the Acorn name 'MATRIX'. The second 'P' line will do
likewise, but using the local print queue 'epson' and Acorn name 'FX80'.

You can specify an email address as a printer name and the print server
will send the print traffic by email *providing you have set up a mail
delivery subsystem such as sendmail or exim*. See below.

Equally, you can have two fileservers, but they must be on *different*
emulated stations, e.g.:

F 0 254 32768 /econet
F 0 253 32767 /filestore

THE PRINT SERVER
----------------

There is a rough and ready print server built into the bridge utility which
is usable by Econet stations (including on AUN) whether logged in or not.

Configuration line syntax is:

P n s port printer[:6 character Acorn name]

... where:

n, s are network and station number. (The kernel module will listen for
traffic on the Econet wire.)

port is the UDP port to listen on for AUN traffic for this emulated service

printer is *either*

1.	The name of a printer queue configured with 'lpadmin' (as to which
	see its manual page

OR

2.	An email address. You will need a configured, working sendmail
	implementation on your Pi, with suitable mail routing/smart host.

If there is an @ symbol in the printer name, the bridge will assume it is an
email address. Avoid printer queues with @ symbols in them...

Example:

P 0 251 32768 matrix    
... will send received print jobs, with a header, to the 'matrix' queue, and

P 0 251 32768 user@example.com
... will email them in plain text to the given address

As the 'printer' parameter can be specified as NNNNNN:dddddd, where
NNNNNN is the Econet name of the pritner, and 'dddddd' is the unix printer
name or email address, this allows multiple printers to be established
on a single virtual server. Configuration-wise, that is achieved by
putting multiple P lines in the config, e.g.:

P 0 251 32768 samsung:LASER
P 0 251 32768 epson:FX80 
P 0 251 32768 someone@somewhere.com:EMAIL

NOTE: the 'NNNNNN' has a maximum length of 6 characters.

The purpose of this is that when the SJ functionality is turned on (which
is the default - you can turn it off with the -j switch), the *PRINTER
command will let you select which printer your station prints to when
it sends a print job.

*** Note: In a recent version upgrade, this functionality changed.

The above will work fine, but you can now optinally define a print
handler script with the configuration line

PRINTHANDLER <scriptname>

If you define a printhandler, the bridge will not insert its usual
header or footer data onto print jobs, nor will it internally call
lp or sendmail any more.

A print handler script (which handles jobs to locally defined printers
and detects email address destinations) is provided in the repo as
pserv.sh . NOTE THAT THIS WILL DELETE THE SOURCE FILE CREATED BY
THE BRIDGE. So if you test it on the command line, DON'T test it
with a source file (i.e. print data) which you need to keep!

To use this:

A. Copy pserv.sh to /etc/econet-gpio/pserv.sh (you may need to be root)
B. As root if need be, change the ownership & permissions on the script:
	chown pi:pi /etc/econet-gpio/pserv.sh
	chmod ug=rx,o= /etc/econet-gpio/pserv.sh
C. Create a directory /etc/econet-gpio/printers
D. Copy the examples from the printers directory in the repo into
   /etc/econet-gpio/printers

The content of the printers directory provides default & specific ways
of introducing header files and command line switches to the lp or
sendmail commands which are finally used to deliver print jobs to their
ultimate destinations.

The files are called header.XXX and conf.XXX where the 'header' file
is prepended to the print job when it is sent, and 'conf' contains
bash variable definitions to enable command line switches to be
pre-pended to the sendmail or lp command line (i.e. after 'lp' but
before any other parameters) in case you want to tweak how your
system prints things.

Suppose a user ("CHRIS") prints a job to a printer ("LASER"), the
system will search for header and conf files in priority as follows
(all within /etc/econet-gpio/printers):

LASER.CHRIS.header
LASER.header
default.header

Thus the particular user can have a specific header file, but if not
then the printer itself can have a specific header, and otherwise
the default header will be picked up.

The header files can have variables substituted into them before
the job is sent. They are fairly self-explanatory in most cases:

_USERNAME_ : Logged in username, or 'ANONYMOUS' if not logged in
_SERVERNETWORK_ : Network number of print server
_SERVERSTATION_ : Station number of print server
_NETWORK_ : Network number of client station
_STATION_ : Station number of client station
_DESTINATION_ : Unix destination of print job (e.g. 'printer1'
   or 'example@examle.com'
_DATE_ : Date in dd/mm/YYYY format
_TIME_ : Time in hh:mm format

The same priority system happens for the conf files.

If the printing user is not logged into a PiFS fileserver, their
username will show as 'ANONYMOUS'. Thus, a particular header for
not logged in users can be created with, e.g., a massive banner
saying that someone is trying to print without logging in(!).

If you are sending by email, you should really have a bespoke
header file because it can put the minimal email headers (To:
and Subject:) into the output. An example for a printer called
'EMAIL' is provided.

The conf files simply have two lines (both optional):

cmdopts="..."
cmdexec="..."

The first is the command options to put after the name of the
deliverying binary (lp or sendmail depending on whether there is
an '@' in the unix destination for the job).

The second (cmdexec) allows you to specify a particular binary
to do final delivery if you don't want lp or sendmail for this
printer. E.g. if you wanted to send the print job by some 
sort of messaging service you can access over the Internet.

THE FILESERVER
--------------

The bridge code now includes what appears to be a relatively stable Level3-ish
fileserver. It implements most functions. THERE MAY STILL BE BUGS. YOU MAY
GET CORRUPTED FILES. YOU HAVE BEEN WARNED.

FURTHER IMPORTANT NOTE: No Library, Welcome or Utilities are provided with
this software. You will need your own and you will need to copy them onto
the system using something like COPYF. If you search the various enthusiast
sites, I am sure you will find them. COPYF should work to copy them to a 
newly created Library directory as SYST once you get the server up and running.

One function not implemented is user quotas. READFREE will return something,
but it will be erroneous. SETFREE will appear to complete but achieve nothing.

The server is *broadly* a Level 3-esque server. One day I will implement
the SJ Research addons. It has some differences:

 - It has permissions on directories which are typically enforced
 - There is a concept of an 'owner' for each file or directory. Whereas
   Level 3's semantics were that a user owned everything below their
   home direcotry, that is not so in this implementation. Ownership can
   be viewed with *OWNER, and changed with *CHOWN. 
 - Thus permissions on a file in your home directory as an ordinary user
   *may* be the ones *after* the / in the permissions if you don't
   own it.
 - Where the L3 server will not permit *DIR ^ within your home directory
   or $, this server *will*. From home it has the expected behaviour.
   From $ (or if $ is home) it will effectively be ignored.
 - One day there may be switches to turn some of this on and off.

Configuration file syntax:

F n s port dir

Where:

n, s are network and station number to emulate
port is the port to listen on for AUN traffic
dir is the top level directory for the server.

WITHIN 'dir' you MUST create at least one directory whose name is of the
format nNAME, where 'n' is a single digit 0-9 (which will become the disc
number in Econet world) and 'NAME' is the (up to 16 character) disc name
in Econet world

All those folders MUST be owned by the user that runs the bridge utility.

E.g. If you configure

F 0 254 32768 /econet

You would then:

mkdir /econet
mkdir /econet/0ECONET
mkdir /econet/1STORAGE

chown -R pi /econet

Start the bridge, and you should see it initialize the fileserver. 

The password file will NOT be visible on the main discs. It is stored in the
top level directory - in the example, /econet/Passwords

On first execution, if Passwords does not exist it will be created with one
user 'SYST' with a blank password.

All the Econet files are then stored in the Linux filesystem. Filenames are
subject to conversion of '/' (which is permissible in a BBC filename) to ':'
(which is not) so that individual filenames do not attempt to straddle Linux
directories. 

By default, Load, Execute and Econet owner are stored as extended attributes,
so you need to make sure your filesystem supports them. Ext4 does by default
on the standard Pi installation.

If your filesystem does not support extended attributes then you can use the
-x flag to disable this, and instead the attributes are stored an in "inf"
file.  So a filename !BOOT would have an additional !BOOT.inf that stores the
four values.

This mode can also be enabled by creating a file called auto_inf in a
server directory.  So, for example, if you have
  F 0 254 32768 /econet
then if the file /econet/auto_inf exists then it will automatically
apply -x mode, and this will show in the log
  FS: Attempting to initialize server 0 on 0.254 at directory /econet
  FS: Automatically turned on -x mode because of /econet/auto_inf

Even on a filesystem with extended attributes enabled, if an inf file is
found then this will be used in preference, so !BOOT.inf will be used if
it exists.


You can mount each disc as a separate filesystem if you wish. The FS code will
ignore the lost+found directory.

Most things work. There is some weird problem with the Get Object Info
FS function which, it would appear, is actually used to SET load/execute
in certain circumstances, but I have not figured out how to tell when that is
so. The "COPYF" utility appears to do this, for example.

Wildcards
---------

I have implemented the * and # BBC wildcards best I can. I think they work.
If you get odd results, please post somewhere and if I get to hear about it
I will try to investigate when I can.

Permissions
-----------

More complex than Level 3. Directories can have WR attributes as well,
and a lack of write access to a directory ought to prevent creation of 
a new file / directory therein.

There is an 'H' attribute which hides the file from directory listings for
all but the owner & system users.

The 'L' attribute does what the Acorn one does. However, if you use the
*LINK functionality (see below), the FS will automatically set the L attribute
in the hope that it will remind you that one of the apparently identical files
is the *actual* unix file because if you delete that one, things will go 
haywire. (There is a need for some sanity checking there - be prepared for
seg faults if you push this too hard.)

Special files
-------------

System privilege users can open the file %Passwords in any directory
and will receive a handle to the system passwords file which is not in fact
accessible in the Econet directory hierarchy.

CLI commands implemented in the server
--------------------------------------

Non-privileged commands:

*ACCESS <filespec> <attr>
	- Change attributes on <filespec> which can be wildcard
	- attr must contain LHWR before the /, and only WR after (or some
	  subset of each).
	- If no / provided, all attr letters presumed to relate to owner.
	- Letters after the '/' are for non-owner (public) access.
	
*BYE
	- Log out

*CDIR <dirname>
	- Create new directory

*CHOWN <filename>
	- Take ownership of <filename> if you own the directory it's in
	  or are a system user

*COPY <source> <destination>
	- Source can be wildcard. If it resolves to more than one file, then
	  <destination> *must* be a directory
	- Done inside the server - does not use network time.

*DELETE <filespec>
	- Delete files matching wildcard specification given
	- Will refuse to delete locked files, and directories which are not
	  empty.

*DIR <directory>
	- Change current working directory

*I AM (<station>) <username> (<password>)
	- Log in

*INFO <filename>
	- Show load, execute, length & system internal name for one file
	- Abbreviated to *I.

*LIB <directory>
	- Temporarily change library directory

*LOGIN
	- As * I AM

*OWNER <filename>
	- Display owner name as an error

*PASS <old password> <: or new password>
	- Change password

*PRINTER <printer>
	- Select one of several printers on the fileserver. Note,
	  this command only works if your print server is also a
	  fileserver, because the *PRINTER command operates only on
	  printers which are configured on the same local server as
	  the fileserver you are logged into. This mirrors what I
	  understand to be the SJ Research functionality of the
	  command.
	  ALSO only works if the SJ functionality is turned on
	  (which is the default; turned off with the -j switch)

*RENAME <old filename> <new filename>
	- Does what it says on the tin.
	- Can be abbreviated to *REN.

*SDISC <discname>
	- Select different fileserver disc.
	- (The library utility *DISCS should show a list)

*SETLIB <dir>
	- Set your library directory. Effective from next login.
	- Setting the directory to % removes the setting and gives you
  	  the system default library.

Privileged commands:

*FLOG <station>
	- Force log a station off

*LINK <source> <destination>
	- Create symlink in the filesystem. <destination> will be the identical
	  file to source.
	- Note that the system will automatically set the L attribute on the
	  original file to remind you not to delete it, but it will show on 
	  all the linked copies too. Take care - if you remove the underlying
	  file, you will likely get a Seg fault when accessing any of the links.
	- This is all rather experimental.
	- Also, the file interlocks (which are implemented!) will not notice
	  one user opening the original file for writing and another opening
	  a link for writing.

*NETCONF <+/-OPTION>
	- Turns FS options on/off. These persist across restarts.
	- There are two at present:
	
		*NETCONF +ACORNHOME / *NETCONF -ACORNHOME
			Turns Acorn home directory semantics on/off
			When on, a user will be treated as owning everything
			in and below their home directory regardless of how
			ownership is actually set in the permissions.

		*NETCONF +MDFS / *NETCONF -MDFS
			Turns SJ MDFS functionality on off. 
			(Previously this was global across all fileservers
			 running on a particular bridge.)
	
*NEWUSER <username>
	- Create new user.
	- This now DOES create a home directory $.Username on the first disc
	- And will set its ownership up correctly
	- Note that you can change a user's home directory with *SETHOME
	- but that will NOT change ownership - a user can thereby have 
	- a home directory they do not own.

	- NOTE: If you turn on the ACORNHOME option (*NETCONF +ACORNHOME)
	- then Acorn Home directory ownership semantics will apply, and
	- the user will be treated as owning everything below their
	- home directory, whether the FS thinks they really own it or 
	- not.

	- To delete a user, see *PRIV

*PRIV <user> <priv>
	- Set user privilege. Applicable privileges are:
		D - Deleted - user cannot log in, password entry will be reused
		L - Locked user - cannot log in
		N - Unlocked (normal) user, but cannot change password
		S - System user
		U - Unlocked (normal) user
		
*SETHOME (<username>) <directory>
	- Permanently set replacement home directory (effective next login)
	- If <username> omitted, works for the calling user.
	- Otherwise operates on the named user if they exist.
	- <directory> can include a :DISC prefix

*SETLIB (<username>) <directory>
	- See above. System users may specify the optional username.

*UNLINK <link>
	- Removes a symlink created with *LINK

THE END
-------

Enjoy!
